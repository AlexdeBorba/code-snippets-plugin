{"generator":"Code Snippets v2.14.0","date_created":"2020-03-26 15:54","snippets":[{"name":"WordPress: Purge all expired transients by wp_cron","tags":["woocommerce","transients","cron","purge"],"scope":"global","code":"\/\/ Schedule the CRON Job to purge all expired transients\n\nif (!wp_next_scheduled('purge_popup_transients_cron')) {\n\n\t\/**\n\t * wp_schedule_event\n\t *\n\t * @param - When to start the CRON job\n\t * @param - The interval in for each subsequent run\n\t * @param - The name of the CRON JOB\n\t *\/\n\n\twp_schedule_event( time(), 'daily', 'purge_popup_transients_cron');\n}\n\nadd_action( 'purg_transients_cron',  'purge_transients', 10 ,2);\n\n\/**\n * Deletes all transients that have expired\n *\n * @access public\n * @static\n * @return void\n *\/\nstatic function purge_popup_transients($older_than = '1 day', $safemode = true) {\n\n\tglobal $wpdb;\n\t$older_than_time = strtotime('-' . $older_than);\n\n\t\/**\n\t * Only check if the transients are older than the specified time\n\t *\/\n\n\tif ( $older_than_time > time() || $older_than_time < 1 ) {\n\t\treturn false;\n\t}\n\n\t\/**\n\t * Get all the expired transients\n\t *\n\t * @var mixed\n\t * @access public\n\t *\/\n\t$transients = $wpdb->get_col(\n\t\t$wpdb->prepare( \"\n\t\t\t\tSELECT REPLACE(option_name, '_transient_timeout_', '') AS transient_name\n\t\t\t\tFROM {$wpdb->options}\n\t\t\t\tWHERE option_name LIKE '\\_transient\\_timeout\\__%%'\n\t\t\t\t\tAND option_value < %s\n\t\t\", $older_than_time)\n\t);\n\n\t\/**\n\t * If safemode is ON just use the default WordPress get_transient() function\n\t * to delete the expired transients\n\t *\/\n\n\tif ( $safemode ) {\n\t\tforeach( $transients as $transient ) {\n\t\t\tget_transient($transient);\n\t\t}\n\t}\n\n\t\/**\n\t * If safemode is OFF the just manually delete all the transient rows in the database\n\t *\/\n\n\telse {\n\t\t$options_names = array();\n\t\tforeach($transients as $transient) {\n\t\t\t$options_names[] = '_transient_' . $transient;\n\t\t\t$options_names[] = '_transient_timeout_' . $transient;\n\t\t}\n\t\tif ($options_names) {\n\t\t\t$options_names = array_map(array($wpdb, 'escape'), $options_names);\n\t\t\t$options_names = \"'\". implode(\"','\", $options_names) .\"'\";\n\n\t\t\t$result = $wpdb->query( \"DELETE FROM {$wpdb->options} WHERE option_name IN ({$options_names})\" );\n\t\t\tif (!$result) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn $transients;\n}","priority":"10"}]}